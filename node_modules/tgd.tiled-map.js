var Mobil = require("tgd.mobil");

/**
 * @param options Un objet d√©crivant la carte, avec les attributs suivants :
 * * __cols__: nombre de colonnes dans la carte.
 * * __rows__: nombre de lignes dans la carte.
 * * __tileWidth__: largeur d'une tuile en pixels.
 * * __tileHeight__: hauteur d'une tuile en pixels.
 * * __mapWidth__: largeur de la partie visible de la carte en pixels.
 * * __mapHeight__: hauteur de la partie visible de la carte en pixels.
 * 
 * @example
 * var TiledMap = require("tgd.tiled-map");
 * var options = {
 *   cols: 200,
 *   rows: 10,
 *   tileWidth: 32,
 *   tileHeight: 32
 * }
 * var instance = new TiledMap(options);
 * @class TiledMap
 */
var TiledMap = function(options) {
    this.clear();
    if (typeof options === 'undefined') options = {};

    Mobil.call(this, options);
    this.origX = options.origX || 0;
    this.origY = options.origY || 0;
    this.origSpeedX = options.origSpeedX || 0;
    this.origSpeedY = options.origSpeedY || 0;
    this.origAccelX = options.origAccelX || 0;
    this.origAccelY = options.origAccelY || 0;
    this.cols = options.cols || 20;
    this.rows = options.rows || 20;
    this.tileWidth = options.tileWidth || 32;
    this.tileHeight = options.tileHeight || 32;
    this.mapWidth = options.mapWidth || 320;
    this.mapHeight = options.mapHeight || 240;
};

TiledMap.prototype = Object.create(Mobil.prototype);
TiledMap.prototype.constructor = TiledMap;

/**
 * @return void
 */
TiledMap.prototype.setTile = function(col, row, mobil) {
    this._tiles[row + "." + col] = mobil;
};

/**
 * @return void
 */
TiledMap.prototype.getTile = function(col, row) {
    return this._tiles[row + "." + col];
};

/**
 * Supprimer toutes les tuiles de la carte.
 */
TiledMap.prototype.clear = function() {
    this._tiles = {};
};

/**
 * @return void
 */
TiledMap.prototype.doMove = function(runtime) {
    var delta = runtime.deltaTimestamp / 1000;
    this.origX += this.origSpeedX * delta;
    this.origY += this.origSpeedY * delta;
    this.origSpeedX += this.origAccelX * delta;
    this.origSpeedY += this.origAccelY * delta;
    Mobil.prototype.doMove.call(this, runtime);
};

/**
 * @return void
 */
TiledMap.prototype.doDraw = function(runtime) {
    var col = this.origX / this.tileWidth;
    var row = this.origY / this.tileHeight;
    var shiftX = this.tileWidth * (Math.floor(col) - col);
    var shiftY = this.tileHeight * (Math.floor(row) - row);
    col = Math.floor(col);
    row = Math.floor(row);
    var ctx = runtime.context;
    ctx.beginPath();
    ctx.rect(0, 0, this.mapWidth, this.mapHeight);
    ctx.clip();
    
    var j, i;
    var visibleCols = Math.ceil(this.mapWidth / this.tileWidth) + 1;
    var visibleRows = Math.ceil(this.mapHeight / this.tileHeight) + 1;
    var centerX = this.tileWidth / 2 + shiftX;
    var centerY = this.tileHeight / 2 + shiftY;
    for (j = 0 ;  j < visibleRows ; j++) {
        var currentRow = (j + row) % this.rows;
        for (i = 0 ;  i < visibleCols ; i++) {
            var currentCol = (i + col) % this.cols;
            var mobil = this.getTile(currentCol, currentRow);
            if (mobil) {
                ctx.save();
                ctx.translate(i * this.tileWidth + centerX, j * this.tileHeight + centerY);
                mobil.doDraw(runtime);
                ctx.restore();
            }
        }
    }
    Mobil.prototype.doDraw.call(this, runtime);
};

module.exports = TiledMap;